<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Application</title>
  <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
</head>
<body>

  <h2>Chat Application</h2>

  <div>
    <label for="email">Email:</label>
    <input type="email" id="email" placeholder="Enter your email" />
  </div>

  <div>
    <label for="password">Password:</label>
    <input type="password" id="password" placeholder="Enter your password" />
  </div>

  <button onclick="login()">Login</button>

  <div>
    <label for="receiverId">Receiver ID:</label>
    <input type="text" id="receiverId" placeholder="Enter receiver's user ID" />
  </div>

  <div>
    <label for="message">Message:</label>
    <textarea id="message" rows="4" cols="50" placeholder="Type your message..."></textarea>
  </div>

  <button onclick="sendMessage()">Send Message</button>

  <div class="messages" id="messages"></div>

  <script>
    let socket;

    // Hàm đăng nhập và lưu token
    async function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      const response = await fetch('http://localhost:3002/api/v1/auth/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email, password }),
      });

      const data = await response.json();

      if (data && data.data && data.data.accessToken) {
        localStorage.setItem('accessToken', data.data.accessToken);  // Lưu token vào localStorage
        alert('Login successful!');
        connectSocket();  // Kết nối WebSocket sau khi đăng nhập
      } else {
        alert('Login failed!');
      }
    }

    // Hàm kết nối WebSocket với token
    function connectSocket() {
      const accessToken = localStorage.getItem("accessToken");

      if (!accessToken) {
        alert("No access token found. Please login.");
        return;
      }

      socket = io("http://localhost:3001", {
        transports: ["websocket"],
        query: { token: accessToken },  // Gửi token vào query
      });

      socket.on("receiveMessage", (message) => {
        console.log("Received message:", message);
        displayMessage(message);
      });
    }

    // Hàm gửi tin nhắn
    function sendMessage() {
      const receiverId = document.getElementById("receiverId").value;
      const message = document.getElementById("message").value;

      if (!receiverId || !message) {
        alert("Please fill in all fields.");
        return;
      }

      socket.emit("sendMessage", {
        senderId: localStorage.getItem("userId"),  // Lấy userId từ localStorage
        receiverId,
        message,
      });
    }

    // Hàm hiển thị tin nhắn lên giao diện
    function displayMessage(message) {
      const messageContainer = document.getElementById("messages");
      const messageElement = document.createElement("div");
      messageElement.innerHTML = `<strong>${message.senderId}:</strong> ${message.message}`;
      messageContainer.appendChild(messageElement);
    }
  </script>

</body>
</html>
